{% extends "base.html" %}

{% block content %}
    <h1>Add a New Trade</h1>
    <form method="POST" action="{{ url_for('main.add_trade') }}">
        <fieldset>
            <div class="form-group">
                <label for="ticker" class="form-label mt-4">Symbol</label>
                <select class="form-select" id="ticker" name="ticker" required>
                    {% for sym in symbols %}
                        <option value="{{ sym }}">{{ sym }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="entry_date" class="form-label mt-4">Entry Date</label>
                <input type="datetime-local" class="form-control" id="entry_date" name="entry_date" required>
            </div>
            <div class="form-group">
                <label for="entry_price" class="form-label mt-4">Entry Price</label>
                <input type="number" step="any" class="form-control" id="entry_price" name="entry_price" required>
            </div>
            <div class="form-group">
                <label for="position_size" class="form-label mt-4">Position Size</label>
                <input type="number" step="any" class="form-control" id="position_size" name="position_size" required>
            </div>
            <div class="form-group">
                <label for="direction" class="form-label mt-4">Direction</label>
                <select class="form-select" id="direction" name="direction">
                    <option>Long</option>
                    <option>Short</option>
                </select>
            </div>
            <div class="form-group">
                <label for="exit_date" class="form-label mt-4">Exit Date</label>
                <input type="datetime-local" class="form-control" id="exit_date" name="exit_date">
            </div>
            <div class="form-group">
                <label for="exit_price" class="form-label mt-4">Exit Price</label>
                <input type="number" step="any" class="form-control" id="exit_price" name="exit_price">
            </div>
            <div class="form-group">
                <label class="form-label mt-4">Strategy</label>
                <div id="strategy-picker" class="d-flex flex-wrap gap-2">
                    {% for strat in strategies %}
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="strategy_choice" id="strat-{{ loop.index }}" value="{{ strat }}" required>
                            <label class="form-check-label btn btn-outline-info" for="strat-{{ loop.index }}">{{ strat }}</label>
                        </div>
                    {% endfor %}
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="strategy_choice" id="strat-new-toggle" value="__new__" required>
                        <label class="form-check-label btn btn-outline-success" for="strat-new-toggle">+ Add New</label>
                    </div>
                </div>
                <div class="input-group mt-2" id="strategy_new_group" style="display: none;">
                    <input type="text" class="form-control" id="strategy_new_input" placeholder="Enter new strategy name">
                    <button class="btn btn-success" type="button" id="add_strategy_btn">Add</button>
                </div>
            </div>
            <div class="form-group">
                <label for="notes" class="form-label mt-4">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary mt-4">Add Trade</button>
        </fieldset>
    </form>
{% endblock %}

{% block scripts %}
<script>
    // --- Exit Date Defaulting ---
    const entryDateInput = document.getElementById('entry_date');
    const exitDateInput = document.getElementById('exit_date');

    entryDateInput.addEventListener('input', () => {
        if (entryDateInput.value) {
            exitDateInput.value = entryDateInput.value;
        }
    });

    // --- Strategy Picker Logic ---
    const strategyPicker = document.getElementById('strategy-picker');
    const newStrategyGroup = document.getElementById('strategy_new_group');
    const newStrategyInput = document.getElementById('strategy_new_input');
    const addStrategyBtn = document.getElementById('add_strategy_btn');
    const newStratToggle = document.getElementById('strat-new-toggle');

    strategyPicker.addEventListener('change', (event) => {
        if (event.target.name === 'strategy_choice') {
            if (event.target.value === '__new__') {
                newStrategyGroup.style.display = 'flex';
                newStrategyInput.focus();
            } else {
                newStrategyGroup.style.display = 'none';
            }
        }
    });

    addStrategyBtn.addEventListener('click', () => {
        const newStrategyName = newStrategyInput.value.trim();
        if (newStrategyName) {
            // Create the new radio button and label
            const newIndex = strategyPicker.querySelectorAll('.form-check').length;
            const newFormCheck = document.createElement('div');
            newFormCheck.className = 'form-check';

            const newRadio = document.createElement('input');
            newRadio.type = 'radio';
            newRadio.className = 'form-check-input';
            newRadio.name = 'strategy_choice';
            newRadio.id = `strat-${newIndex}`;
            newRadio.value = newStrategyName;
            newRadio.required = true;

            const newLabel = document.createElement('label');
            newLabel.className = 'form-check-label btn btn-outline-info';
            newLabel.htmlFor = newRadio.id;
            newLabel.textContent = newStrategyName;

            newFormCheck.appendChild(newRadio);
            newFormCheck.appendChild(newLabel);

            // Insert before the '+ Add New' button's container
            strategyPicker.insertBefore(newFormCheck, newStratToggle.parentElement);

            // Select the new button and hide the input
            newRadio.checked = true;
            newStrategyGroup.style.display = 'none';
            newStrategyInput.value = '';
        }
    });
</script>
{% endblock %} 