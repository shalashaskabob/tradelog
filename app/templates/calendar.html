{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mt-4">
    <h1>{{ month_name }} {{ year }} PnL Calendar</h1>
    <div>
        <a href="{{ url_for('main.calendar', year=year-1, month=month) }}" class="btn btn-outline-secondary">&laquo; {{ year-1 }}</a>
        <a href="{{ url_for('main.calendar', year=year, month=month-1 if month > 1 else 12, year=year if month > 1 else year-1) }}" class="btn btn-outline-secondary">&lsaquo; Prev</a>
        <a href="{{ url_for('main.calendar', year=year, month=month+1 if month < 12 else 1, year=year if month < 12 else year+1) }}" class="btn btn-outline-secondary">Next &rsaquo;</a>
        <a href="{{ url_for('main.calendar', year=year+1, month=month) }}" class="btn btn-outline-secondary">{{ year+1 }} &raquo;</a>
    </div>
</div>
<div class="card mt-4">
    <div class="card-body">
        <table class="table table-dark table-bordered text-center align-middle mb-0">
            <thead>
                <tr>
                    <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                </tr>
            </thead>
            <tbody>
                {% for week in cal_grid %}
                <tr>
                    {% set week_num = loop.index0 + 1 %}
                    {% set week_iso = None %}
                    {% for day in week %}
                        {% if day != 0 %}
                            {% set d = day %}
                            {% set date_obj = namespace(val=none) %}
                            {% set date_obj.val = day|string + '-' + month|string + '-' + year|string %}
                            {% set this_date = year ~ '-' ~ '%02d' % month ~ '-' ~ '%02d' % day %}
                            {% set dt = this_date|to_datetime('%Y-%m-%d') %}
                            {% set day_pnl = daily_pnl.get(dt.date(), 0) %}
                            {% set trades = daily_trades.get(dt.date(), []) %}
                            <td class="p-1" style="vertical-align: top;">
                                <div class="fw-bold {% if day_pnl > 0 %}text-success{% elif day_pnl < 0 %}text-danger{% else %}text-secondary{% endif %}">
                                    {{ day_pnl|round(2) }}
                                </div>
                                <div class="small text-muted">{{ day }}</div>
                                {% if trades|length > 0 %}
                                    <div class="small">{{ trades|length }} trade{{ 's' if trades|length > 1 else '' }}</div>
                                {% endif %}
                            </td>
                        {% else %}
                            <td class="bg-secondary"></td>
                        {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td colspan="7" class="text-end small text-info">
                        Week PnL: {{ week_pnl.get(week[0]|to_datetime('%Y-%m-%d').isocalendar()[1], 0)|round(2) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %} 